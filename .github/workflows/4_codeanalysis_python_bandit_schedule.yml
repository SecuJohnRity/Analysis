name: Python code analysis
on:
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 2'
  push:
    branches:
      - enhancement/29541-expand-bandit-scan

jobs:
  pick-branches:
    name: Get branches to analyze
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate dynamic matrix
        id: set-matrix
        run: |
          VERSIONED_BRANCHES_REGEX="^main$|^[0-9]{1,3}\.[0-9]{2}\.[0-9]{1,2}$"

          BRANCHES=$(git branch -r | awk '{print $1}' | sed 's|origin/||' | grep -E "$VERSIONED_BRANCHES_REGEX")

          JSON_ARRAY=$(printf '%s\n' "$BRANCHES" | while read -r ref; do
            sha=$(git rev-parse "origin/$ref")
            jq -c -n --arg ref "$ref" --arg sha "$sha" '{ref: $ref, sha: $sha}'
          done | jq -c -s '{include: .}')

          echo "matrix=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
          echo Picked branches: $JSON_ARRAY

  bandit:
    name: Python static code analysis
    needs: pick-branches
    strategy:
      matrix: ${{ fromJSON(needs.pick-branches.outputs.matrix) }}
    uses: ./.github/workflows/4_codeanalysis_python_bandit.yml
    with:
      branch: ${{ matrix.ref }}
    secrets: inherit
